<template>
    <div class="cart-page dark-theme">
        <!-- È†ÅÈù¢Ê®ôÈ°å -->
        <section class="title-section">
            <div>
                <h1 class="main-title">Ë≥ºÁâ© <span class="text-highlight">Ë≥ºÁâ©Ëªä</span></h1>
                <p class="subtitle">Êü•ÁúãÂ∑≤ÈÅ∏ÂïÜÂìÅÔºåË™øÊï¥Êï∏ÈáèÊàñÁßªÈô§Ôºå‰∏¶ÂÆåÊàêÁµêÂ∏≥</p>
            </div>
        </section>

        <!-- Ë≥ºÁâ©ËªäÂÖßÂÆπ -->
        <section class="cart-section">
            <div class="section-container">
                <div v-if="loading" class="loading-container">
                    <el-skeleton :rows="3" animated style="width: 100%" />
                </div>

                <div v-else-if="cartItems.length === 0" class="empty-cart">
                    <el-empty description="Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ">
                        <el-button type="primary" @click="goToProducts">ÂéªÈÅ∏Ë≥ºÂïÜÂìÅ</el-button>
                    </el-empty>
                </div>

                <div v-else class="cart-content">
                    <div class="cart-items">
                        <div class="cart-header">
                            <h3 class="header-title">ÊÇ®ÁöÑË≥ºÁâ©Ê∏ÖÂñÆ</h3>
                            <el-button type="danger" plain @click="confirmClearCart">
                                Ê∏ÖÁ©∫Ë≥ºÁâ©Ëªä
                            </el-button>
                        </div>

                        <el-table
                            :data="cartItems"
                            style="width: 100%"
                            class="cart-table"
                            row-key="id"
                        >
                            <el-table-column label="ÂïÜÂìÅ" min-width="300">
                                <template #default="scope">
                                    <div class="cart-item">
                                        <div class="item-image">
                                            <img
                                                :src="getProductImageUrl(scope.row.product)"
                                                :alt="
                                                    scope.row.product
                                                        ? scope.row.product.name
                                                        : 'Product'
                                                "
                                                onerror="this.onerror=null; this.src='https://placehold.co/120x120/1e293b/ffffff?text=Image+Not+Found'"
                                            />
                                        </div>
                                        <div class="item-details">
                                            <h4 class="item-name">
                                                {{
                                                    scope.row.product
                                                        ? scope.row.product.name
                                                        : "Êú™Áü•ÂïÜÂìÅ"
                                                }}
                                            </h4>
                                            <p class="item-category">
                                                ÂàÜÈ°û:
                                                {{
                                                    scope.row.product
                                                        ? formatCategory(scope.row.product.category)
                                                        : "ÂÖ∂‰ªñ"
                                                }}
                                            </p>
                                            <p
                                                v-if="
                                                    scope.row.product &&
                                                    scope.row.product.stockQuantity <= 5
                                                "
                                                class="low-stock"
                                            >
                                                ÂÉÖÂâ© {{ scope.row.product.stockQuantity }} ‰ª∂
                                            </p>
                                            <p v-if="!scope.row.product" class="error-message">
                                                ÂïÜÂìÅ‰ø°ÊÅØ‰∏çÂèØÁî®
                                            </p>
                                        </div>
                                    </div>
                                </template>
                            </el-table-column>

                            <el-table-column label="ÂñÆÂÉπ" width="150">
                                <template #default="scope">
                                    <div class="price-container">
                                        <span class="price">
                                            NT$
                                            {{ scope.row.product ? scope.row.product.price : "0" }}
                                        </span>
                                    </div>
                                </template>
                            </el-table-column>

                            <el-table-column label="Êï∏Èáè" width="180">
                                <template #default="scope">
                                    <div class="quantity-control">
                                        <el-input-number
                                            v-model="scope.row.quantity"
                                            :min="1"
                                            :max="
                                                scope.row.product
                                                    ? scope.row.product.stockQuantity
                                                    : 1
                                            "
                                            size="small"
                                            @change="
                                                (value) => handleQuantityChange(scope.row.id, value)
                                            "
                                        />
                                    </div>
                                </template>
                            </el-table-column>

                            <el-table-column label="Â∞èË®à" width="150">
                                <template #default="scope">
                                    <span class="subtotal">
                                        NT$ {{ calculateSubtotal(scope.row) }}
                                    </span>
                                </template>
                            </el-table-column>

                            <el-table-column width="80">
                                <template #default="scope">
                                    <el-button
                                        type="danger"
                                        size="small"
                                        circle
                                        @click="confirmRemoveItem(scope.row)"
                                    >
                                        <el-icon><Delete /></el-icon>
                                    </el-button>
                                </template>
                            </el-table-column>
                        </el-table>

                        <!-- Ë≥ºÁâ©ËªäÁ∏ΩÁµê -->
                        <div class="cart-summary">
                            <div class="summary-row">
                                <span class="summary-label">ÂïÜÂìÅÂ∞èË®à:</span>
                                <span class="summary-value">NT$ {{ totalAmount }}</span>
                            </div>
                            <div class="summary-row">
                                <span>ÈÅãË≤ª:</span>
                                <span class="summary-value">NT$ {{ shipping }}</span>
                            </div>
                            <div v-if="freeShipping" class="summary-row free-shipping">
                                <span></span>
                                <span class="free-shipping-tag">üéâ Ë≥ºÁâ©ÊªøNT$1000ÂÖçÈÅãË≤ª</span>
                            </div>
                            <div class="summary-row total">
                                <span class="summary-label">Ë®ÇÂñÆÁ∏ΩÈ°ç:</span>
                                <span class="summary-value highlight">NT$ {{ grandTotal }}</span>
                            </div>
                            <div class="action-buttons">
                                <el-button @click="goToProducts">ÁπºÁ∫åË≥ºÁâ©</el-button>
                                <el-button type="primary" @click="checkoutHandler">
                                    ÁµêÂ∏≥
                                </el-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Êé®Ëñ¶ÂïÜÂìÅ -->
        <section v-if="recommendedProducts.length > 0" class="recommended-section">
            <div class="section-container">
                <h2 class="section-title">Êé®Ëñ¶ÂïÜÂìÅ</h2>
                <div class="recommended-products">
                    <div
                        v-for="product in recommendedProducts"
                        :key="product.id"
                        class="recommended-product"
                        @click="goToProductDetail(product.id)"
                    >
                        <div class="product-image">
                            <img
                                :src="getProductImageUrl(product)"
                                :alt="product.name"
                                onerror="this.onerror=null; this.src='https://placehold.co/200x200/cccccc/ffffff?text=Image+Not+Found'"
                            />
                        </div>
                        <div class="product-info">
                            <h3 class="product-name">{{ product.name }}</h3>
                            <div class="product-price">
                                <span class="current-price">NT$ {{ product.price }}</span>
                            </div>
                            <el-button
                                type="success"
                                class="add-to-cart-btn"
                                @click.stop="addItemToCartHandler(product)"
                                :disabled="product.stockQuantity <= 0"
                            >
                                <el-icon><ShoppingCart /></el-icon> Âä†ÂÖ•Ë≥ºÁâ©Ëªä
                            </el-button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</template>

<script>
import { ref, computed, onMounted } from "vue";
import { useRouter } from "vue-router";
import { ElMessage, ElMessageBox } from "element-plus";
import { Delete, ShoppingCart } from "@element-plus/icons-vue";
import {
    getCartItems,
    updateCartItemQuantity,
    removeFromCart,
    clearCart,
    addItemToCart,
    getProducts,
    fetchProductForCartItem,
    createOrderFromCart,
} from "@/api/shop";

export default {
    name: "CartPage",
    components: {
        Delete,
        ShoppingCart,
    },
    setup() {
        const router = useRouter();
        const cartItems = ref([]);
        const loading = ref(false);
        const recommendedProducts = ref([]);
        const freeShipping = ref(false);

        // ËºîÂä©ÂáΩÊï∏ÔºöÁç≤ÂèñÁï∂ÂâçÁî®Êà∂ID
        const getUserId = () => {
            let userId = null;

            // ÂòóË©¶Â§öÁ®ÆÂèØËÉΩÁöÑÂ≠òÂÑ≤‰ΩçÁΩÆ
            // 1. localStorage‰∏≠ÁöÑuserInfo
            try {
                const userInfo = localStorage.getItem("userInfo");
                if (userInfo) {
                    const parsedInfo = JSON.parse(userInfo);
                    userId = parsedInfo?.id || parsedInfo?.userId;
                    if (userId) return userId;
                }
            } catch (e) {
                console.error("ÂæûuserInfoÁç≤ÂèñuserIdÂ§±Êïó:", e);
            }

            // 2. localStorage‰∏≠ÁöÑauthStore
            try {
                const authStore = localStorage.getItem("authStore");
                if (authStore) {
                    const parsedStore = JSON.parse(authStore);
                    userId = parsedStore?.userInfo?.id || parsedStore?.userId;
                    if (userId) return userId;
                }
            } catch (e) {
                console.error("ÂæûauthStoreÁç≤ÂèñuserIdÂ§±Êïó:", e);
            }

            // 3. Áõ¥Êé•ÂæûlocalStorage‰∏≠ÁöÑuserId
            try {
                userId = localStorage.getItem("userId");
                if (userId) return userId;
            } catch (e) {
                console.error("ÂæûuserIdÁç≤ÂèñÂ§±Êïó:", e);
            }

            return null;
        };

        // Ê™¢Êü•Áï∂ÂâçÁî®Êà∂ÊòØÂê¶Â∑≤ÁôªÂÖ•
        const isUserLoggedIn = () => {
            return !!localStorage.getItem("authToken");
        };

        // Áç≤ÂèñË≥ºÁâ©ËªäÈ†ÖÁõÆ
        const fetchCartItems = async () => {
            try {
                loading.value = true;
                const response = await getCartItems();
                console.log("Ë≥ºÁâ©ËªäAPIÈüøÊáâ:", response);

                if (response && response.data) {
                    // ËôïÁêÜÂæåÁ´ØËøîÂõûÁöÑÊï∏Êìö
                    let items = [];
                    if (Array.isArray(response.data)) {
                        items = response.data;
                    } else if (response.data.content && Array.isArray(response.data.content)) {
                        items = response.data.content;
                    } else if (response.data.data && Array.isArray(response.data.data)) {
                        // ËôïÁêÜ{success: true, data: [...]}Ê†ºÂºèÁöÑÂõûÊáâ
                        items = response.data.data;
                    }

                    console.log("ÂéüÂßãË≥ºÁâ©ËªäÈ†ÖÁõÆ:", items);

                    // Á∞°ÂåñÈÅéÊøæÈÇèËºØ - Âè™Ë¶ÅÊúâidÂ∞±Ë¶ñÁÇ∫ÊúâÊïàÈ†ÖÁõÆ
                    cartItems.value = items.filter((item) => item && (item.id || item.cartItemId));
                    console.log("ÈÅéÊøæÂæåÁöÑË≥ºÁâ©ËªäÈ†ÖÁõÆ:", cartItems.value);

                    // Â¶ÇÊûúË≥ºÁâ©ËªäÊúâÈ†ÖÁõÆÔºå‰ΩÜÁº∫Â∞ëÂïÜÂìÅ‰ø°ÊÅØÔºåË©¶ËëóÁç≤Âèñ
                    if (cartItems.value.length > 0) {
                        const missingProductItems = cartItems.value.filter(
                            (item) => !item.product || !item.product.name
                        );

                        if (missingProductItems.length > 0) {
                            console.log(
                                `Êúâ${missingProductItems.length}ÂÄãÈ†ÖÁõÆÁº∫Â∞ëÂïÜÂìÅ‰ø°ÊÅØÔºåÂòóË©¶Áç≤Âèñ`
                            );
                            const promises = missingProductItems.map((item) =>
                                fetchProductForCartItem(item)
                            );
                            await Promise.allSettled(promises);
                            cartItems.value = [...cartItems.value]; // Âº∑Âà∂Êõ¥Êñ∞ÂºïÁî®
                        }

                        // ÁÑ°Ë´ñÊòØÂê¶ÊúâÂÆåÊï¥‰ø°ÊÅØÔºåÈÉΩÂ∞áË≥ºÁâ©ËªäÈ†ÖÁõÆ‰øùÂ≠òÂà∞localStorage
                        localStorage.setItem("cart", JSON.stringify(cartItems.value));
                    }
                } else {
                    // ÂòóË©¶ÂæûlocalStorageËÆÄÂèñË≥ºÁâ©Ëªä
                    const localCart = localStorage.getItem("cart");
                    if (localCart) {
                        try {
                            const parsedCart = JSON.parse(localCart);
                            if (Array.isArray(parsedCart) && parsedCart.length > 0) {
                                cartItems.value = parsedCart;
                                console.log("ÂæûlocalStorageËºâÂÖ•Ë≥ºÁâ©Ëªä:", cartItems.value);
                            } else {
                                cartItems.value = [];
                            }
                        } catch (e) {
                            console.error("Ëß£ÊûêlocalStorageË≥ºÁâ©ËªäÊï∏ÊìöÈåØË™§:", e);
                            cartItems.value = [];
                        }
                    } else {
                        cartItems.value = [];
                    }
                }

                // Â¶ÇÊûúË≥ºÁâ©ËªäÊúâÈ†ÖÁõÆÔºåÁç≤ÂèñÊé®Ëñ¶ÂïÜÂìÅ
                if (cartItems.value.length > 0) {
                    fetchRecommendedProducts();
                }
            } catch (error) {
                console.error("Failed to fetch cart items:", error);
                if (error.response && error.response.status === 401) {
                    ElMessage.warning("Ë´ãÂÖàÁôªÂÖ•ÂæåÊü•ÁúãË≥ºÁâ©Ëªä");
                    router.push("/user/login");
                } else {
                    ElMessage.error(error.displayMessage || "Áç≤ÂèñË≥ºÁâ©ËªäÂ§±Êïó");

                    // ÂòóË©¶ÂæûÊú¨Âú∞Â≠òÂÑ≤Âä†Ëºâ
                    const localCart = localStorage.getItem("cart");
                    if (localCart) {
                        try {
                            const parsedCart = JSON.parse(localCart);
                            if (Array.isArray(parsedCart)) {
                                cartItems.value = parsedCart;
                                console.log("APIÈåØË™§ÔºåÂæûlocalStorageËºâÂÖ•Ë≥ºÁâ©Ëªä:", cartItems.value);
                            }
                        } catch (e) {
                            cartItems.value = [];
                        }
                    }
                }
            } finally {
                loading.value = false;
            }
        };

        // Áç≤ÂèñÊé®Ëñ¶ÂïÜÂìÅ
        const fetchRecommendedProducts = async () => {
            try {
                // ÂæûÂ∑≤ÊúâÂïÜÂìÅÁöÑÈ°ûÂà•‰∏≠Áç≤ÂèñÁõ∏‰ººÂïÜÂìÅ
                const categories = cartItems.value
                    .filter((item) => item && item.product) // Á¢∫‰øùÂè™ËôïÁêÜÊúâÊïàÁöÑË≥ºÁâ©ËªäÈ†ÖÁõÆ
                    .map((item) => item.product?.category)
                    .filter((value) => value !== undefined && value !== null)
                    .filter((value, index, self) => self.indexOf(value) === index);

                // Â¶ÇÊûúÊ≤íÊúâÊúâÊïàÁöÑÈ°ûÂà•Ôºå‰∏çÈÄ≤Ë°åË´ãÊ±Ç
                if (categories.length === 0) {
                    console.log("ÁÑ°Ê≥ïÊâæÂà∞ÊúâÊïàÁöÑÂïÜÂìÅÈ°ûÂà•ÔºåÁÑ°Ê≥ïÁç≤ÂèñÊé®Ëñ¶ÂïÜÂìÅ");
                    recommendedProducts.value = [];
                    return;
                }

                const response = await getProducts({
                    limit: 4,
                    categories: categories.join(","),
                });

                if (response && response.data) {
                    let products = [];

                    if (Array.isArray(response.data)) {
                        products = response.data;
                    } else if (response.data.content && Array.isArray(response.data.content)) {
                        products = response.data.content;
                    } else if (response.data.data && Array.isArray(response.data.data)) {
                        products = response.data.data;
                    }

                    // Á¢∫‰øùÂè™ËôïÁêÜÊúâÊïàÁöÑÁî¢ÂìÅ
                    products = products.filter((product) => product && product.id);

                    // ÈÅéÊøæÊéâÂ∑≤Á∂ìÂú®Ë≥ºÁâ©Ëªä‰∏≠ÁöÑÂïÜÂìÅÔºå‰ΩøÁî®ÂÆâÂÖ®ÁöÑÊñπÂºè
                    const cartProductIds = cartItems.value
                        .filter((item) => item && item.product)
                        .map((item) => item.product.id);

                    recommendedProducts.value = products
                        .filter((product) => !cartProductIds.includes(product.id))
                        .slice(0, 4);

                    console.log(`Áç≤Âèñ‰∫Ü${recommendedProducts.value.length}ÂÄãÊé®Ëñ¶ÂïÜÂìÅ`);
                }
            } catch (error) {
                console.error("Failed to fetch recommended products:", error);
                recommendedProducts.value = [];
            }
        };

        // Êõ¥Êñ∞Ë≥ºÁâ©ËªäÈ†ÖÁõÆÊï∏Èáè
        const handleQuantityChange = async (itemId, quantity) => {
            try {
                await updateCartItemQuantity({
                    cartItemId: itemId,
                    quantity,
                });
                // APIÊàêÂäüÂêéÊõ¥Êñ∞Êú¨Âú∞
                const item = cartItems.value.find((i) => i.id === itemId);
                if (item) {
                    item.quantity = quantity;
                }
                ElMessage.success("Ë≥ºÁâ©ËªäÊï∏ÈáèÂ∑≤Êõ¥Êñ∞");
            } catch (error) {
                console.error("Failed to update quantity:", error);
                // ÈáçÊñ∞Âä†ËºâË≥ºÁâ©Ëªä‰ª•ÊÅ¢Âæ©Ê≠£Á¢∫Êï∏Èáè
                fetchCartItems();
                ElMessage.error(error.displayMessage || "Êõ¥Êñ∞Êï∏ÈáèÂ§±Êïó");
            }
        };

        // Á¢∫Ë™çÂà™Èô§ÂïÜÂìÅ
        const confirmRemoveItem = (item) => {
            ElMessageBox.confirm(
                `Á¢∫ÂÆöË¶ÅÂæûË≥ºÁâ©Ëªä‰∏≠ÁßªÈô§ ${item.product ? item.product.name : "Ê≠§ÂïÜÂìÅ"} Âóé?`,
                "Á¢∫Ë™çÁßªÈô§",
                {
                    confirmButtonText: "Á¢∫ÂÆö",
                    cancelButtonText: "ÂèñÊ∂à",
                    type: "warning",
                }
            )
                .then(() => {
                    removeCartItem(item.id);
                })
                .catch(() => {
                    // Áî®Êà∂ÂèñÊ∂à
                });
        };

        // ÂæûË≥ºÁâ©Ëªä‰∏≠ÁßªÈô§ÂïÜÂìÅ
        const removeCartItem = async (itemId) => {
            try {
                await removeFromCart({
                    cartItemId: itemId,
                });
                // APIÊàêÂäüÂêéÊõ¥Êñ∞Êú¨Âú∞
                cartItems.value = cartItems.value.filter((item) => item.id !== itemId);
                ElMessage.success("ÂïÜÂìÅÂ∑≤ÂæûË≥ºÁâ©ËªäÁßªÈô§");

                // Â¶ÇÊûúË≥ºÁâ©ËªäÁÇ∫Á©∫ÔºåÊ∏ÖÁ©∫Êé®Ëñ¶ÂïÜÂìÅ
                if (cartItems.value.length === 0) {
                    recommendedProducts.value = [];
                }
            } catch (error) {
                console.error("Failed to remove item from cart:", error);
                ElMessage.error(error.displayMessage || "ÁßªÈô§ÂïÜÂìÅÂ§±Êïó");
            }
        };

        // Á¢∫Ë™çÊ∏ÖÁ©∫Ë≥ºÁâ©Ëªä
        const confirmClearCart = () => {
            ElMessageBox.confirm("Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫Ë≥ºÁâ©ËªäÂóé?", "Á¢∫Ë™çÊ∏ÖÁ©∫", {
                confirmButtonText: "Á¢∫ÂÆö",
                cancelButtonText: "ÂèñÊ∂à",
                type: "warning",
            })
                .then(() => {
                    clearCartHandler();
                })
                .catch(() => {
                    // Áî®Êà∂ÂèñÊ∂à
                });
        };

        // Ê∏ÖÁ©∫Ë≥ºÁâ©Ëªä
        const clearCartHandler = async () => {
            try {
                await clearCart();
                cartItems.value = [];
                recommendedProducts.value = [];
                ElMessage.success("Ë≥ºÁâ©ËªäÂ∑≤Ê∏ÖÁ©∫");
            } catch (error) {
                console.error("Failed to clear cart:", error);
                ElMessage.error(error.displayMessage || "Ê∏ÖÁ©∫Ë≥ºÁâ©ËªäÂ§±Êïó");
            }
        };

        // Áç≤ÂèñÂïÜÂìÅÂúñÁâáURLÁöÑÊñπÊ≥ïÔºåËôïÁêÜÂêÑÁ®ÆÂèØËÉΩÁöÑURLÊ†ºÂºè
        const getProductImageUrl = (product) => {
            // Ê™¢Êü• product ÊòØÂê¶Â≠òÂú®
            if (!product) {
                return "https://placehold.co/400x300/cccccc/ffffff?text=No+Product";
            }

            // Ê™¢Êü•ÂêÑÁ®ÆÂèØËÉΩÁöÑÂúñÁâáURLÂ±¨ÊÄß
            if (product.imageUrl) {
                // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÂÆåÊï¥URLÈÇÑÊòØÁõ∏Â∞çË∑ØÂæë
                if (product.imageUrl.startsWith("http") || product.imageUrl.startsWith("https")) {
                    return product.imageUrl;
                } else {
                    // ÂÅáË®≠ÊòØÁõ∏Â∞çË∑ØÂæëÔºåÊ∑ªÂä†ÂæåÁ´ØÂü∫Á§éURL
                    return `http://localhost:8080${product.imageUrl}`;
                }
            }

            if (product.image) {
                if (product.image.startsWith("http") || product.image.startsWith("https")) {
                    return product.image;
                } else {
                    return `http://localhost:8080${product.image}`;
                }
            }

            if (product.img || product.imgUrl) {
                const imgPath = product.img || product.imgUrl;
                if (imgPath.startsWith("http") || imgPath.startsWith("https")) {
                    return imgPath;
                } else {
                    return `http://localhost:8080${imgPath}`;
                }
            }

            // Â¶ÇÊûúÊâÄÊúâÂòóË©¶ÈÉΩÂ§±ÊïóÔºå‰ΩøÁî®ÈªòË™çÈ°èËâ≤‰Ωî‰ΩçÂúñ
            const colors = {
                protein: "4CAF50",
                preworkout: "FF9800",
                creatine: "2196F3",
                equipment: "FF5722",
                accessories: "9C27B0",
                yoga: "3F51B5",
            };

            const color = product.category ? colors[product.category] || "4CAF50" : "cccccc";
            const productName = product.name || "Unknown Product";
            return `https://placehold.co/400x300/${color}/ffffff?text=${encodeURIComponent(
                productName
            )}`;
        };

        // Ë®àÁÆóÊäòÊâ£ÂÉπÊ†º
        const calculateDiscountedPrice = (product) => {
            return product.price;
        };

        // Ë®àÁÆóÂïÜÂìÅÂ∞èË®à
        const calculateSubtotal = (item) => {
            if (!item) return "0";

            // ËôïÁêÜÁî¢ÂìÅ‰ø°ÊÅØ‰∏çÂÆåÊï¥ÁöÑÊÉÖÊ≥Å
            let price = 0;
            if (item.product && item.product.price) {
                price = Number(item.product.price);
            } else if (item.price) {
                // Áõ¥Êé•ÂæûÈ†ÖÁõÆÁç≤ÂèñÂÉπÊ†º
                price = Number(item.price);
            } else if (item.unitPrice) {
                price = Number(item.unitPrice);
            }

            // Á¢∫‰øùÊï∏ÈáèÊòØÊúâÊïàÊï∏Â≠ó
            const quantity = item.quantity ? Number(item.quantity) : 1;

            return (price * quantity).toFixed(0);
        };

        // Ë®àÁÆóÁ∏ΩÈ°ç
        const totalAmount = computed(() => {
            return cartItems.value
                .reduce((total, item) => {
                    // ‰ΩøÁî®calculateSubtotal‰æÜÁç≤ÂèñÊØèÂÄãÈ†ÖÁõÆÁöÑÂ∞èË®à
                    const subtotal = parseFloat(calculateSubtotal(item)) || 0;
                    return total + subtotal;
                }, 0)
                .toFixed(0);
        });

        // ÈÅãË≤ªË®àÁÆó
        const shipping = computed(() => {
            // Á∞°ÂñÆÁöÑÈÅãË≤ªË®àÁÆóÈÇèËºØÔºåË≥ºÁâ©Êªø1000ÂÖçÈÅãË≤ª
            let shippingValue = Number(totalAmount.value) >= 1000 ? 0 : 60;

            // Ë®òÈåÑÂÖçÈÅãË≤ªÁãÄÊÖã‰æõÊ®°Êùø‰ΩøÁî®
            freeShipping.value = shippingValue === 0;

            return shippingValue;
        });

        // Ë®ÇÂñÆÁ∏ΩÈ°ç
        const grandTotal = computed(() => {
            return (Number(totalAmount.value) + shipping.value).toFixed(0);
        });

        // Ê∑ªÂä†Âà∞Ë≥ºÁâ©Ëªä
        const addItemToCartHandler = async (product) => {
            try {
                if (product.stockQuantity <= 0) {
                    ElMessage.warning("Ë©≤ÂïÜÂìÅÁõÆÂâçÁÑ°Â∫´Â≠ò");
                    return;
                }

                await addItemToCart({
                    productId: product.id,
                    quantity: 1,
                });

                ElMessage.success("ÊàêÂäüÂä†ÂÖ•Ë≥ºÁâ©Ëªä");
                // ÈáçÊñ∞Âä†ËºâË≥ºÁâ©Ëªä
                fetchCartItems();
            } catch (error) {
                console.error("Failed to add to cart:", error);
                if (error.response && error.response.status === 401) {
                    ElMessage.warning("Ë´ãÂÖàÁôªÂÖ•ÂæåÂÜçÂä†ÂÖ•Ë≥ºÁâ©Ëªä");
                    router.push("/user/login");
                } else {
                    ElMessage.error(error.displayMessage || "Âä†ÂÖ•Ë≥ºÁâ©ËªäÂ§±Êïó");
                }
            }
        };

        // Ê†ºÂºèÂåñÈ°ûÂà•ÂêçÁ®±
        const formatCategory = (category) => {
            if (!category) return "ÂÖ∂‰ªñ";

            const categoryMap = {
                protein: "ËõãÁôΩË≥™",
                preworkout: "Ë®ìÁ∑¥Ââç",
                creatine: "ËÇåÈÖ∏",
                equipment: "ÂÅ•Ë∫´Âô®Êùê",
                accessories: "ÂÅ•Ë∫´ÈÖç‰ª∂",
                yoga: "Áëú‰ºΩÁî®ÂìÅ",
            };

            return categoryMap[category.toLowerCase()] || category;
        };

        // ÂâçÂæÄÂïÜÂìÅÈ†ÅÈù¢
        const goToProducts = () => {
            router.push("/shop/products");
        };

        // ÂâçÂæÄÂïÜÂìÅË©≥ÊÉÖÈ†Å
        const goToProductDetail = (productId) => {
            router.push(`/shop/products/${productId}`);
        };

        // ÁµêÂ∏≥ËôïÁêÜ
        const checkoutHandler = async () => {
            // Ë™øË©¶Ë≥ºÁâ©ËªäÁãÄÊÖã
            console.log("Ë≥ºÁâ©ËªäÂÖßÂÆπÔºö", cartItems.value);
            console.log("Ë≥ºÁâ©ËªäÁâ©ÂìÅÊï∏ÈáèÔºö", cartItems.value.length);

            if (!cartItems.value || cartItems.value.length === 0) {
                ElMessage.warning("Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑÔºåË´ãÂÖàÂä†ÂÖ•ÂïÜÂìÅ");
                return;
            }

            try {
                // Á¢∫‰øùÁî®Êà∂Â∑≤ÁôªÂÖ•
                if (!isUserLoggedIn()) {
                    ElMessage.warning("Ë´ãÂÖàÁôªÂÖ•ÂæåÂÜçÈÄ≤Ë°åÁµêÂ∏≥");
                    router.push("/user/login");
                    return;
                }

                // ‰øùÂ≠òË≥ºÁâ©ËªäÊï∏ÊìöÂà∞localStorage‰ΩúÁÇ∫ÂÇô‰ªΩ
                localStorage.setItem("checkoutCart", JSON.stringify(cartItems.value));
                localStorage.setItem("cartTotal", totalAmount.value);
                localStorage.setItem("cartGrandTotal", grandTotal.value);
                localStorage.setItem("cartShipping", shipping.value.toString());

                console.log(`ÁµêÂ∏≥ÊµÅÁ®ãÈñãÂßãÔºåË≥ºÁâ©ËªäÂÖ±Êúâ ${cartItems.value.length} ‰ª∂ÂïÜÂìÅ`);
                console.log(`Á∏ΩÈáëÈ°ç: ${totalAmount.value}`);

                // È°ØÁ§∫Âä†ËºâÊ∂àÊÅØ
                loading.value = true;
                ElMessage.info("Ê≠£Âú®Ê∫ñÂÇôË®ÇÂñÆ...");

                try {
                    // Áç≤ÂèñÁî®Êà∂ID
                    const userId = getUserId();

                    // Â¶ÇÊûúÁÑ°Ê≥ïÁç≤ÂèñÁî®Êà∂IDÔºåË´ãÊ±ÇÁôªÂÖ•
                    if (!userId) {
                        ElMessage.warning("ÁÑ°Ê≥ïÁç≤ÂèñÁî®Êà∂‰ø°ÊÅØÔºåË´ãÈáçÊñ∞ÁôªÂÖ•");
                        router.push("/user/login");
                        loading.value = false;
                        return;
                    }

                    console.log(`ÂòóË©¶ÂâµÂª∫Ë®ÇÂñÆÔºåÁî®Êà∂ID: ${userId}`);

                    // ÂâµÂª∫Ë®ÇÂñÆ
                    const response = await createOrderFromCart(userId);
                    console.log("ÂâµÂª∫Ë®ÇÂñÆÈüøÊáâ:", response);

                    // ËôïÁêÜAPIÊàêÂäüÈüøÊáâ
                    if (response && response.data) {
                        let orderId = null;

                        // ËôïÁêÜ‰∏çÂêåÊ†ºÂºèÁöÑÈüøÊáâ
                        if (response.data.success && response.data.data && response.data.data.id) {
                            orderId = response.data.data.id;
                        } else if (response.data.id) {
                            orderId = response.data.id;
                        } else if (response.data.orderId) {
                            orderId = response.data.orderId;
                        }

                        if (orderId) {
                            // Ë®ÇÂñÆÂâµÂª∫ÊàêÂäü
                            ElMessage.success("Ë®ÇÂñÆÂâµÂª∫ÊàêÂäüÔºåÂç≥Â∞áË∑≥ËΩâÂà∞Ë®ÇÂñÆË©≥ÊÉÖ");

                            // Ê∏ÖÁ©∫Ë≥ºÁâ©Ëªä
                            cartItems.value = [];
                            localStorage.removeItem("cart"); // Ê∏ÖÈô§localStorage‰∏≠ÁöÑË≥ºÁâ©Ëªä

                            // Âª∂ÈÅ≤‰∏Ä‰∏ãÂÜçË∑≥ËΩâ
                            setTimeout(() => {
                                // Ë∑≥ËΩâÂà∞Ë®ÇÂñÆË©≥ÊÉÖÈ†Å
                                router.push(`/shop/orders/${orderId}`);
                            }, 1000);
                            return;
                        }
                    }

                    // Â¶ÇÊûú‰∏äÈù¢ÁöÑ‰ª£Á¢ºÊ≤íÊúâÊàêÂäüËôïÁêÜË®ÇÂñÆÂâµÂª∫ÔºåÂâáÂõûÈÄÄÂà∞ËàäÁöÑÁµêÂ∏≥Ë°åÁÇ∫
                    console.log("‰ΩøÁî®ÂÇôÈÅ∏ÁµêÂ∏≥ÈÇèËºØ - ÂòóË©¶Ë∑≥ËΩâÂà∞ÁµêÂ∏≥È†ÅÈù¢");

                    // Ê™¢Êü•ÊòØÂê¶Êúâ/shop/checkoutË∑ØÁî±
                    router.push("/shop/checkout").catch((error) => {
                        console.error("Â∞éËà™Âà∞ÁµêÂ∏≥È†ÅÈù¢Â§±Êïó:", error);
                        // Â¶ÇÊûúÊ≤íÊúâcheckoutÈ†ÅÈù¢ÔºåÈ°ØÁ§∫ÊèêÁ§∫
                        ElMessage.error("ÁµêÂ∏≥È†ÅÈù¢‰∏çÂ≠òÂú®ÔºåË´ãËÅØÁπ´ÁÆ°ÁêÜÂì°");
                    });
                } catch (error) {
                    console.error("ÂâµÂª∫Ë®ÇÂñÆÂ§±Êïó:", error);

                    // Âà§Êñ∑ÈåØË™§È°ûÂûã
                    if (error.response && error.response.status === 401) {
                        ElMessage.warning("ÁôªÂÖ•ÁãÄÊÖãÂ∑≤ÈÅéÊúüÔºåË´ãÈáçÊñ∞ÁôªÂÖ•");
                        router.push("/user/login");
                        return;
                    }

                    ElMessage.error("Ë®ÇÂñÆÂâµÂª∫Â§±ÊïóÔºåÊ≠£Âú®ÂòóË©¶ÂÇôÈÅ∏ÁµêÂ∏≥ÊµÅÁ®ã");

                    // Âõ†Ë®ÇÂñÆÂâµÂª∫Â§±ÊïóÔºå‰ªçÂòóË©¶Ë∑≥ËΩâÂà∞ÁµêÂ∏≥È†ÅÈù¢
                    router.push("/shop/checkout").catch((error) => {
                        console.error("Â∞éËà™Âà∞ÁµêÂ∏≥È†ÅÈù¢Â§±Êïó:", error);
                        ElMessage.error("ÁÑ°Ê≥ïÂÆåÊàêÁµêÂ∏≥ÔºåË´ãÁ®çÂæåÂÜçË©¶");
                    });
                } finally {
                    loading.value = false;
                }
            } catch (error) {
                console.error("ÁµêÂ∏≥ÈÅéÁ®ãÁôºÁîüÈåØË™§:", error);
                ElMessage.error("ÁµêÂ∏≥ÈÅéÁ®ãÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶");
                loading.value = false;
            }
        };

        // ÂàùÂßãÂåñ
        onMounted(() => {
            window.scrollTo(0, 0);
            fetchCartItems();
        });

        return {
            cartItems,
            loading,
            recommendedProducts,
            totalAmount,
            shipping,
            grandTotal,
            freeShipping,
            getProductImageUrl,
            calculateDiscountedPrice,
            calculateSubtotal,
            handleQuantityChange,
            confirmRemoveItem,
            confirmClearCart,
            formatCategory,
            goToProducts,
            goToProductDetail,
            checkoutHandler,
            addItemToCartHandler,
        };
    },
};
</script>

<style lang="scss" scoped>
.cart-page {
    background-color: #111827;
    color: #f5f5f5;
    min-height: 100vh;
    width: 100%;
    margin: 0;
    padding-top: 80px; /* ÁÇ∫Â∞éËà™Ê¨ÑÈ†êÁïôÁ©∫Èñì */
    overflow-x: hidden;
}

.text-highlight {
    color: #10b981;
    font-weight: 600;
}

.section-container {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 40px;
}

// È†ÅÈù¢Ê®ôÈ°å
.title-section {
    padding: 3rem 0;
    text-align: center;

    .main-title {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        display: inline-block;
    }

    .subtitle {
        font-size: 1.2rem;
        color: #9ca3af;
        max-width: 800px;
        margin: 0 auto;
    }
}

// Ë≥ºÁâ©ËªäÂçÄÂüü
.cart-section {
    padding-bottom: 3rem;
    background-color: #111827;

    .section-container {
        background-color: #111827;
    }
}

// Ë≥ºÁâ©ËªäÂÖßÂÆπ
.cart-content {
    background-color: #1e293b;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

// Ë≥ºÁâ©ËªäÈ†≠ÈÉ®
.cart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #2d3748;

    .header-title {
        font-size: 1.4rem;
        margin: 0;
    }
}

// Ë≥ºÁâ©ËªäË°®Ê†º
.cart-table {
    width: 100%;
    border-collapse: collapse;
    background-color: #1e293b;
    border-bottom: 1px solid #2d3748;
}

.cart-item {
    display: flex;
    align-items: center;
    gap: 1rem;

    .item-image {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        overflow: hidden;
        background-color: #111827;

        img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
    }

    .item-details {
        .item-name {
            margin: 0 0 0.5rem;
            font-size: 1.1rem;
        }

        .item-category {
            color: #9ca3af;
            margin: 0 0 0.3rem;
        }

        .low-stock {
            color: #ff9800;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .error-message {
            color: #ff4757;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }
    }
}

// ÂÉπÊ†ºÈ°ØÁ§∫
.price-container {
    display: flex;
    flex-direction: column;

    .price {
        color: #f5f5f5;
        font-weight: bold;
    }
}

// Êï∏ÈáèÊéßÂà∂
.quantity-control {
    display: flex;
    align-items: center;
}

// Â∞èË®à
.subtotal {
    font-weight: bold;
    color: #10b981;
}

// Ë≥ºÁâ©ËªäÁ∏ΩÁµê
.cart-summary {
    background-color: #2d3748;
    padding: 1.5rem;
    border-radius: 0 0 12px 12px;

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.8rem;

        &.total {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #4b5563;
            font-weight: bold;
        }
    }

    .summary-label {
        color: #d1d5db;
    }

    .summary-value {
        font-weight: 500;

        &.highlight {
            color: #10b981;
            font-size: 1.3rem;
        }
    }

    .action-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        margin-top: 1.5rem;
    }
}

// Á©∫Ë≥ºÁâ©Ëªä
.empty-cart {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem 0;
    background-color: #1e293b;
    border-radius: 12px;
    min-height: 300px;
}

// Âä†Ëºâ‰∏≠
.loading-container {
    padding: 3rem;
    background-color: #1e293b;
    border-radius: 12px;
    min-height: 300px;
}

// Êé®Ëñ¶ÂïÜÂìÅÂçÄÂüü
.recommended-section {
    padding: 3rem 0;

    .section-title {
        font-size: 1.8rem;
        margin-bottom: 2rem;
        text-align: center;
    }

    .recommended-products {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1.5rem;
    }

    .recommended-product {
        background-color: #1e293b;
        border-radius: 12px;
        overflow: hidden;
        transition: transform 0.3s, box-shadow 0.3s;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);

        &:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);

            .product-image img {
                transform: scale(1.05);
            }
        }

        .product-image {
            height: 180px;
            position: relative;
            overflow: hidden;
            background-color: transparent;

            img {
                width: 100%;
                height: 100%;
                object-fit: contain;
                transition: transform 0.3s ease;
            }
        }

        .product-info {
            padding: 1.2rem;

            .product-name {
                font-size: 1.1rem;
                margin-top: 0;
                margin-bottom: 1rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .product-price {
                display: flex;
                align-items: center;
                margin-bottom: 1rem;

                .current-price {
                    color: #10b981;
                    font-size: 1.2rem;
                    font-weight: bold;
                }
            }

            .add-to-cart-btn {
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 5px;
            }
        }
    }
}

// ÈüøÊáâÂºèË®≠Ë®à
@media (max-width: 768px) {
    .section-container {
        padding: 0 20px;
    }

    .cart-item {
        flex-direction: column;
        align-items: flex-start;

        .item-image {
            width: 60px;
            height: 60px;
        }
    }

    .cart-header {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
    }

    .cart-summary .action-buttons {
        flex-direction: column;
        width: 100%;
    }
}

:deep(.el-table) {
    background-color: #1e293b;
    color: #f5f5f5;

    .el-table__inner-wrapper::before {
        display: none;
    }
}

:deep(.el-table th),
:deep(.el-table td) {
    background-color: #1e293b;
    color: #f5f5f5;
    border-bottom-color: #2d3748;
}

:deep(.el-table--enable-row-hover .el-table__body tr:hover > td) {
    background-color: #2d3748;
}

:deep(.el-input-number) {
    width: 120px;
}

// Êï¥È´îÈ†ÅÈù¢Ê®£ÂºèË¶ÜËìã
:deep(.el-button--primary) {
    background-color: #10b981;
    border-color: #10b981;

    &:hover,
    &:focus {
        background-color: #059669;
        border-color: #059669;
    }
}

// Êï∏ÈáèÊåâÈàïÂíåÁµêÂ∏≥ÂçÄÂüüËÉåÊôØ
.cart-section {
    .el-button {
        border-radius: 6px;
    }

    .el-input-number.is-controls-right .el-input__wrapper {
        background-color: #1e293b;
        box-shadow: 0 0 0 1px #4b5563 inset;
    }
}

// È†ÅÈù¢ËÉåÊôØ‰øÆÊ≠£
.el-main {
    background-color: #111827;
}

// Ë®≠ÁΩÆÁµêÂ∏≥ÂíåÁπºÁ∫åË≥ºÁâ©ÊåâÈàïÈ°èËâ≤
.action-buttons {
    margin-top: 1.5rem;

    .el-button {
        padding: 12px 24px;
        font-size: 1rem;

        &.el-button--primary {
            background-color: #10b981;
            border-color: #10b981;

            &:hover {
                background-color: #059669;
                border-color: #059669;
            }
        }

        &.el-button--default {
            background-color: #1e293b;
            border-color: #4b5563;
            color: #f5f5f5;

            &:hover {
                background-color: #2d3748;
                border-color: #6b7280;
            }
        }
    }
}

:deep(.el-empty__description) {
    color: #d1d5db;
}

// Ê∑ªÂä†È°çÂ§ñÁöÑÊ∑±Ëâ≤‰∏ªÈ°åÊ®£ÂºèË¶ÜËìã
:deep(.el-button) {
    &.el-button--default {
        background-color: #1e293b;
        border-color: #4b5563;
        color: #f5f5f5;

        &:hover,
        &:focus {
            background-color: #2d3748;
            border-color: #6b7280;
            color: #ffffff;
        }
    }

    &.el-button--danger {
        &.is-plain {
            background-color: transparent;
            color: #f56c6c;
        }
    }
}

:deep(.el-message-box) {
    background-color: #1e293b;
    border-color: #4b5563;

    .el-message-box__title,
    .el-message-box__message {
        color: #f5f5f5;
    }

    .el-message-box__headerbtn .el-message-box__close {
        color: #f5f5f5;
    }

    .el-button {
        &.el-button--default {
            background-color: #2d3748;
            border-color: #4b5563;
            color: #f5f5f5;
        }
    }
}

:deep(.el-message) {
    background-color: #1e293b;
    border-color: #4b5563;

    &.el-message--success {
        background-color: rgba(16, 185, 129, 0.2);
        border-color: #10b981;
    }

    &.el-message--warning {
        background-color: rgba(255, 152, 0, 0.2);
        border-color: #ff9800;
    }

    &.el-message--error {
        background-color: rgba(255, 71, 87, 0.2);
        border-color: #ff4757;
    }
}

// Êñ∞Â¢ûÂÖçÈÅãË≤ªÊ®£Âºè
.free-shipping {
    margin: 0.5rem 0;
    border-bottom: none !important;

    .free-shipping-tag {
        color: #10b981;
        font-size: 0.9rem;
        font-weight: 500;
        padding: 2px 8px;
        background-color: rgba(16, 185, 129, 0.15);
        border-radius: 4px;
    }
}
</style>
